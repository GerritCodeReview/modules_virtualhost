{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "67311424_d1cc1027",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1085901
      },
      "writtenOn": "2023-12-15T12:26:03Z",
      "side": 1,
      "message": "Do I understand correctly, that the only problem is the URL in the git output?\nIf yes, what about the following solution: instead of modifying CanonicalWebUrlProvider install a new ChangeReportFormatter (it is a DynamicItem, so it should be possible to install a custom one). The ChangeReportFormatter can take into account the project name and generate the correct virtual host name.\n\nPros:\n1) Change URLs will be the same in all places where ChangeReportFormatter is used.\n2) We can remove/simplify HttpCanonicalWebUrlProvider - the requestProvider is always null now: the code in WebAppInitializer and in Daemon sets the requestProvider, but later Guice create a new instance of the CanonicalWebUrlProvider on each get() call. So, no reason to keep requestProvider in HttpCanonicalWebUrlProvider.\n\n\nWDYT?",
      "revId": "c893f89b3eedd2b8758f2d40dc833f0ea95ecb3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ce2bcf0e_18cb3a02",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2023-12-15T16:57:48Z",
      "side": 1,
      "message": "\u003e Do I understand correctly, that the only problem is the URL in the git output?\n\nYes, that\u0027s what we have observed now. Haven\u0027t noticed the URL being wrong in ay nay other places. Even in the downloads command the host name is correct.\n\n\n\u003e If yes, what about the following solution: instead of modifying CanonicalWebUrlProvider install a new ChangeReportFormatter (it is a DynamicItem, so it should be possible to install a custom one). The ChangeReportFormatter can take into account the project name and generate the correct virtual host name.\n\nWell, it kinda feels wrong to use `ChangeReportFormatter` only to adjust the hostname. Then we\u0027d also need a mapping from project to the virtual host name to make this work... or inject `Provider\u003cHttpServletRequest\u003e` to get the hostname form request. This feels bad.\n\n\u003e WDYT?\n\nWe just want to change the server URL and it should be possible by a single binding. IMO it would be messy and not developer-friendly if we require to bind more (possibly disconnected) things to \"just\" change the hostname in links.\n\nIs this convincing argumentation?",
      "parentUuid": "67311424_d1cc1027",
      "revId": "c893f89b3eedd2b8758f2d40dc833f0ea95ecb3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b3345a4f_a6ddcbfe",
        "filename": "src/main/java/com/gerritforge/gerrit/modules/virtualhost/VirtualHostHttpCanonicalWebUrlProvider.java",
        "patchSetId": 2
      },
      "lineNbr": 29,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2023-11-27T06:36:55Z",
      "side": 1,
      "message": "question: if that class is a `Singleton` then will it properly serve the canonical url when multiple virtual hosts are specified?",
      "range": {
        "startLine": 29,
        "startChar": 0,
        "endLine": 29,
        "endChar": 10
      },
      "revId": "c893f89b3eedd2b8758f2d40dc833f0ea95ecb3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7080ad4e_8d34989d",
        "filename": "src/main/java/com/gerritforge/gerrit/modules/virtualhost/VirtualHostHttpCanonicalWebUrlProvider.java",
        "patchSetId": 2
      },
      "lineNbr": 29,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2023-11-27T08:08:15Z",
      "side": 1,
      "message": "This is a good question. Yes, there only be a single instance of this class, but it uses \"scoped\" providers to get the server name. The `ThreadLocal` (used internally in `CurrentServerName`) will only be set in a given thread. And, `Provider\u003cHttpServletRequest\u003e` will return the request that is accessing this class.\n\nAt least that\u0027s my understanding how Guice works ;)",
      "parentUuid": "b3345a4f_a6ddcbfe",
      "range": {
        "startLine": 29,
        "startChar": 0,
        "endLine": 29,
        "endChar": 10
      },
      "revId": "c893f89b3eedd2b8758f2d40dc833f0ea95ecb3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}